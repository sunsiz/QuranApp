@page "/settings"
@using QuranBlazor.Services
@inject ExportService ExportService
@inject DialogService Dialog
@inject NavigationManager NavigationManager
@implements IDisposable

@code {
    private TranslationUpdateService updateService;
    private bool isCheckingUpdate = false;
    private bool isUpdating = false;
    private TranslationUpdateService.UpdateInfo updateInfo;
    private string updateMessage = "";
    private int updateProgress = 0;

    private int ArabicFontSize
    {
        get => Preferences.Get(PreferenceKeys.ArabicFontSize, PreferenceKeys.DefaultArabicFontSize);
        set => Preferences.Set(PreferenceKeys.ArabicFontSize, value);
    }

    private int TranslateFontSize
    {
        get => Preferences.Get(PreferenceKeys.TranslateFontSize, PreferenceKeys.DefaultTranslateFontSize);
        set => Preferences.Set(PreferenceKeys.TranslateFontSize, value);
    }

    private int CommentFontSize
    {
        get => Preferences.Get(PreferenceKeys.CommentFontSize, PreferenceKeys.DefaultCommentFontSize);
        set => Preferences.Set(PreferenceKeys.CommentFontSize, value);
    }

    private string UzbekScript
    {
        get => Preferences.Get(PreferenceKeys.UzbekScript, PreferenceKeys.DefaultScript);
        set
        {
            if (Preferences.Get(PreferenceKeys.UzbekScript, PreferenceKeys.DefaultScript) != value)
            {
                Preferences.Set(PreferenceKeys.UzbekScript, value);
                InvokeAsync(StateHasChanged); // Re-render this page
                TransliterationService.NotifyScriptChanged(); // Notify other components
            }
        }
    }

    private string Theme
    {
        get => ThemeService.CurrentTheme;
        set => ThemeService.CurrentTheme = value;
    }

    // Display preferences - using backing fields to ensure proper state management
    private bool _showArabicText = true;
    private bool _showTranslation = true;
    private bool _showFootnotes = true;

    private bool ShowArabicText
    {
        get => _showArabicText;
        set
        {
            // Ensure at least one text type is visible
            if (!value && !_showTranslation)
            {
                // Auto-enable Translation when disabling Arabic
                _showTranslation = true;
                Preferences.Set(PreferenceKeys.ShowTranslation, true);
            }
            _showArabicText = value;
            Preferences.Set(PreferenceKeys.ShowArabicText, value);
            StateHasChanged();
        }
    }

    private bool ShowTranslation
    {
        get => _showTranslation;
        set
        {
            // Ensure at least one text type is visible
            if (!value && !_showArabicText)
            {
                // Auto-enable Arabic when disabling Translation
                _showArabicText = true;
                Preferences.Set(PreferenceKeys.ShowArabicText, true);
            }
            _showTranslation = value;
            Preferences.Set(PreferenceKeys.ShowTranslation, value);
            StateHasChanged();
        }
    }

    private bool ShowFootnotes
    {
        get => _showFootnotes;
        set
        {
            _showFootnotes = value;
            Preferences.Set(PreferenceKeys.ShowFootnotes, value);
            StateHasChanged();
        }
    }
    
    // Helper for display text to avoid direct service call in markup if it gets complex
    private string GetDisplayText(string cyrillicText)
    {
        if (string.IsNullOrEmpty(cyrillicText)) return cyrillicText;
        return UzbekScript == "Latin"
               ? TransliterationService.ToLatin(cyrillicText)
               : cyrillicText;
    }
    // Handler for radio button changes
    private void OnScriptChanged(ChangeEventArgs e)
    {
        UzbekScript = e.Value.ToString();
    }

    private void OnThemeChanged(ChangeEventArgs e)
    {
        Theme = e.Value.ToString();
    }

    private bool isExporting = false;
    private bool isImporting = false;

    private async Task ImportData()
    {
        if (isImporting) return;

        isImporting = true;
        try
        {
            var confirmed = await Dialog.DisplayConfirm(
                TransliterationService.GetDisplayText("Маълумотларни тиклаш"),
                TransliterationService.GetDisplayText("Мавжуд қайдлар ўрнига янгилари қўйилади. Давом эттирасизми?"),
                TransliterationService.GetDisplayText("Ҳа"),
                TransliterationService.GetDisplayText("Йўқ")
            );

            if (!confirmed) return;

            var (notesImported, favoritesImported, error) = await ExportService.ImportFromFileAsync();

            if (!string.IsNullOrEmpty(error))
            {
                if (error != "No file selected")
                {
                    await Dialog.DisplayAlert(
                        TransliterationService.GetDisplayText("Хатолик"),
                        TransliterationService.GetDisplayText($"Тиклаш хатолиги: {error}"),
                        TransliterationService.GetDisplayText("Яхши")
                    );
                }
            }
            else
            {
                var message = $"{notesImported} {TransliterationService.GetDisplayText("та қайд")} ва {favoritesImported} {TransliterationService.GetDisplayText("та белгиланган оят тикланди")}";
                    await Dialog.DisplayToast(TransliterationService.GetDisplayText(message));
            }
        }
        catch (Exception ex)
        {
            await Dialog.DisplayAlert(
                TransliterationService.GetDisplayText("Хатолик"),
                TransliterationService.GetDisplayText($"Тиклаш хатолиги: {ex.Message}"),
                TransliterationService.GetDisplayText("Яхши")
            );
        }
        finally
        {
            isImporting = false;
        }
    }

    private async Task ExportData()
    {
        if (isExporting) return;

        isExporting = true;
        try
        {
            var (notesCount, favoritesCount) = await ExportService.GetDataStatisticsAsync();

            if (notesCount == 0 && favoritesCount == 0)
            {
                await Dialog.DisplayAlert(
                    TransliterationService.GetDisplayText("Маълумот йўқ"),
                    TransliterationService.GetDisplayText("Сизда заҳиралаш учун ҳеч қандай қайд ёки белгиланган оят йўқ."),
                    TransliterationService.GetDisplayText("Яхши")
                );
                return;
            }

            var message = $"{notesCount} {TransliterationService.GetDisplayText("та қайд")} ва {favoritesCount} {TransliterationService.GetDisplayText("та белгиланган оятни заҳиралашни истайсизми?")}";

            var confirmed = await Dialog.DisplayConfirm(
                TransliterationService.GetDisplayText("Маълумотларни заҳиралаш"),
                TransliterationService.GetDisplayText(message),
                TransliterationService.GetDisplayText("Ҳа"),
                TransliterationService.GetDisplayText("Йўқ")
            );

            if (confirmed)
            {
                await ExportService.ShareBackupAsync();
                    await Dialog.DisplayToast(TransliterationService.GetDisplayText("Маълумотлар муваффақиятли заҳираланди"));
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Export error: {ex.Message}");
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Хатолик юз берди"));
        }
        finally
        {
            isExporting = false;
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        
        // Load display preferences from storage
        _showArabicText = Preferences.Get(PreferenceKeys.ShowArabicText, true);
        _showTranslation = Preferences.Get(PreferenceKeys.ShowTranslation, true);
        _showFootnotes = Preferences.Get(PreferenceKeys.ShowFootnotes, true);
        
        // Ensure at least one text type is visible on load
        if (!_showArabicText && !_showTranslation)
        {
            _showArabicText = true;
            Preferences.Set(PreferenceKeys.ShowArabicText, true);
        }
        
        // Initialize update service
        // TODO: Replace with your actual update URL
        updateService = new TranslationUpdateService("https://www.musulmonlar.com/wp-content/uploads/mealdb");
        
        TransliterationService.OnScriptChanged += HandleScriptChanged;
        ThemeService.OnThemeChanged += HandleThemeChanged;
    }

    private async Task CheckForUpdates()
    {
        if (isCheckingUpdate) return;

        isCheckingUpdate = true;
        updateMessage = "";
        
        try
        {
            var (available, info, error) = await updateService.CheckForUpdateAsync();
            
            if (!string.IsNullOrEmpty(error))
            {
                updateMessage = TransliterationService.GetDisplayText($"Хатолик: {error}");
                await Dialog.DisplayToast(updateMessage);
                return;
            }

            if (available && info != null)
            {
                updateInfo = info;
                var confirmed = await Dialog.DisplayConfirm(
                    TransliterationService.GetDisplayText("Янгиланиш мавжуд"),
                    TransliterationService.GetDisplayText($"Версия {info.Version} мавжуд ({info.Size / 1024} KB).\nХозир янгиланишни истайсизми?"),
                    TransliterationService.GetDisplayText("Ҳа"),
                    TransliterationService.GetDisplayText("Йўқ")
                );

                if (confirmed)
                {
                    await InstallUpdate();
                }
            }
            else
            {
                var currentVersion = updateService.GetCurrentDatabaseVersion();
                updateMessage = TransliterationService.GetDisplayText($"Сиз энг сўнгги версиядасиз ({currentVersion})");
                await Dialog.DisplayToast(updateMessage);
            }

            updateService.RecordUpdateCheck();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Update check error: {ex.Message}");
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Янгиланишни текширишда хатолик"));
        }
        finally
        {
            isCheckingUpdate = false;
            StateHasChanged();
        }
    }

    private async Task InstallUpdate()
    {
        if (isUpdating || updateInfo == null) return;

        isUpdating = true;
        updateProgress = 0;
        
        try
        {
            var progress = new Progress<TranslationUpdateService.UpdateProgress>(p =>
            {
                updateProgress = p.ProgressPercentage;
                // Translate the status messages
                updateMessage = p.Status switch
                {
                    "Checking for updates..." => TransliterationService.GetDisplayText("Янгиланишлар текширилмоқда..."),
                    "Downloading update..." => TransliterationService.GetDisplayText("Янгиланиш юкланмоқда..."),
                    "Installing update..." => TransliterationService.GetDisplayText("Янгиланиш ўрнатилмоқда..."),
                    "Verifying download..." => TransliterationService.GetDisplayText("Юклаш текширилмоқда..."),
                    "Update complete" => TransliterationService.GetDisplayText("Янгиланиш тугади"),
                    _ => TransliterationService.GetDisplayText(p.Status) // Fallback to transliteration
                };
                InvokeAsync(StateHasChanged);
            });

            var (success, error) = await updateService.DownloadAndInstallUpdateAsync(updateInfo, progress);

            if (success)
            {
                var confirmed = await Dialog.DisplayConfirm(
                    TransliterationService.GetDisplayText("Янгиланиш муваффақиятли ўрнатилди"),
                    TransliterationService.GetDisplayText("Таржима янгиланди. Иловани қайта юклаш керак. Хозир қайта юклайсизми?"),
                    TransliterationService.GetDisplayText("Ҳа"),
                    TransliterationService.GetDisplayText("Кейинроқ")
                );

                if (confirmed)
                {
                    // Restart app - navigate to home and force reload
                    NavigationManager.NavigateTo("/", forceLoad: true);
                }
            }
            else
            {
                await Dialog.DisplayAlert(
                    TransliterationService.GetDisplayText("Хатолик"),
                    TransliterationService.GetDisplayText($"Янгиланишни ўрнатишда хатолик: {error}"),
                    TransliterationService.GetDisplayText("Яхши")
                );
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Update install error: {ex.Message}");
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Янгиланишни ўрнатишда хатолик"));
        }
        finally
        {
            isUpdating = false;
            updateProgress = 0;
            updateMessage = "";
            StateHasChanged();
        }
    }

    private void HandleScriptChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void HandleThemeChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TransliterationService.OnScriptChanged -= HandleScriptChanged;
        ThemeService.OnThemeChanged -= HandleThemeChanged;
    }
    // private void SetScript(string script)
    // {
    //     UzbekScript = script;
    // }
}
<div class="mx-0">
    <div class="card bg-light bg-gradient rounded-pill">
        <h3 class="px-5 py-2 shadow-lg w-100 card-bg-color bg-gradient rounded-pill card-title text-primary fw-bold"><img src="tune.svg" class="svg-icon svg-icon-xl mx-2 svg-icon-primary" alt="" /> @TransliterationService.GetDisplayText("Созламалар")</h3>@*  oi oi-cog *@
        <div class="card-body">
            <div class="vstack border-3 p-2 m-2 my-3 rounded-pill bg-light bg-gradient shadow-sm">
                <h5 class="card-title hstack gap-3 text-primary">@GetDisplayText("Мавзу")</h5>
                <div class="btn-group w-100" role="group" aria-label="Theme selection">
                    <input type="radio" class="btn-check" name="theme" id="themeLight" value="Light" autocomplete="off" checked="@(Theme == "Light")" @onchange="OnThemeChanged">
                        <label class="btn btn-outline-secondary rounded-start-pill d-flex align-items-center" for="themeLight">
                            <span class="icon-mask icon-light-mode svg-icon-md me-2" aria-hidden="true" title="Light"></span>
                            @GetDisplayText("Ёруғ")
                    </label>

                    <input type="radio" class="btn-check" name="theme" id="themeDark" value="Dark" autocomplete="off" checked="@(Theme == "Dark")" @onchange="OnThemeChanged">
                        <label class="btn btn-outline-secondary rounded-end-pill d-flex align-items-center" for="themeDark">
                            <span class="icon-mask icon-dark-mode svg-icon-md me-2" aria-hidden="true" title="Dark"></span>
                            @GetDisplayText("Тунги")
                    </label>
                </div>
            </div>
            <div class="vstack border-3 p-2 m-2 my-3 rounded-pill bg-light bg-gradient shadow-sm">
                <h5 class="card-title hstack gap-3 text-primary">@GetDisplayText("Ёзув тури")</h5>
                <div class="btn-group w-100" role="group" aria-label="Script selection">
                    <input type="radio" class="btn-check" name="script" id="scriptCyrillic" value="Cyrillic" autocomplete="off" checked="@(UzbekScript == "Cyrillic")" @onchange="OnScriptChanged">
                    <label class="btn btn-outline-secondary rounded-start-pill" for="scriptCyrillic">Кириллча</label>

                    <input type="radio" class="btn-check" name="script" id="scriptLatin" value="Latin" autocomplete="off" checked="@(UzbekScript == "Latin")" @onchange="OnScriptChanged">
                    <label class="btn btn-outline-secondary rounded-end-pill" for="scriptLatin">Lotincha</label>
                </div>
            </div>
            <div class="vstack border-3 p-2 m-2 my-3 rounded-pill bg-light bg-gradient shadow-sm">
                <div class="hstack justify-content-between px-2">
                    <h5 class="card-title text-primary mb-0">@TransliterationService.GetDisplayText("Арабча матн ҳажми")</h5>
                    <span class="badge bg-primary fs-6">@ArabicFontSize px</span>
                </div>
                <input type="range" class="form-range" min="10" max="36" step="1" id="arabicRange" @bind-value="@ArabicFontSize">
                <label style="font-size: @(ArabicFontSize)px; direction: rtl;" class="form-label arabic">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</label>
            </div>
            <div class="vstack border-3 p-2 m-2 m-3 bg-gradient bg-light rounded-pill shadow-sm">
                <div class="hstack justify-content-between px-2">
                    <h5 class="card-title text-primary mb-0">@TransliterationService.GetDisplayText("Шрифт ҳажми")</h5>
                    <span class="badge bg-primary fs-6">@TranslateFontSize px</span>
                </div>
                <input type="range" class="form-range" min="12" max="30" step="1" id="translateRange" @bind-value="@TranslateFontSize">
                <label style="font-size: @(TranslateFontSize)px;" class="form-label">@TransliterationService.GetDisplayText("Марҳамати чексиз ва яхшилик қилувчи – Аллоҳ номи билан.")</label>
            </div>
            <div class="vstack border-3 p-2 m-2 my-3 bg-gradient bg-light rounded-pill shadow-sm">
                <div class="hstack justify-content-between px-2">
                    <h5 class="card-title text-primary mb-0">@TransliterationService.GetDisplayText("Изоҳ матн ҳажми")</h5>
                    <span class="badge bg-primary fs-6">@CommentFontSize px</span>
                </div>
                <input type="range" class="form-range" min="6" max="24" step="1" id="commentRange" @bind-value="@CommentFontSize">
                <label style="font-size: @(CommentFontSize)px;" class="form-label">@TransliterationService.GetDisplayText("«Раҳмон ва Раҳим» калималари «раҳмат» (رحمة) ўзагидан турланган сифатлардир.")</label>
            </div>
            
            <div class="vstack border-3 p-3 m-2 my-3 rounded-4 bg-light bg-gradient shadow-sm">
                <h5 class="card-title text-primary text-center mb-3">@TransliterationService.GetDisplayText("Кўрсатиш созламалари")</h5>
                
                <div class="d-flex flex-column gap-3">
                    <div class="form-check form-switch d-flex align-items-center">
                        <input class="form-check-input me-3" type="checkbox" role="switch" id="showArabicSwitch" 
                               style="width: 3em; height: 1.5em;"
                               checked="@ShowArabicText" @onchange="@((e) => { ShowArabicText = (bool)e.Value; StateHasChanged(); })">
                        <label class="form-check-label flex-grow-1" for="showArabicSwitch">
                            @TransliterationService.GetDisplayText("Арабча матнни кўрсатиш")
                        </label>
                    </div>
                    
                    <div class="form-check form-switch d-flex align-items-center">
                        <input class="form-check-input me-3" type="checkbox" role="switch" id="showTranslationSwitch" 
                               style="width: 3em; height: 1.5em;"
                               checked="@ShowTranslation" @onchange="@((e) => { ShowTranslation = (bool)e.Value; StateHasChanged(); })">
                        <label class="form-check-label flex-grow-1" for="showTranslationSwitch">
                            @TransliterationService.GetDisplayText("Таржимани кўрсатиш")
                        </label>
                    </div>
                    
                    <div class="form-check form-switch d-flex align-items-center">
                        <input class="form-check-input me-3" type="checkbox" role="switch" id="showFootnotesSwitch" 
                               style="width: 3em; height: 1.5em;"
                               checked="@ShowFootnotes" @onchange="@((e) => { ShowFootnotes = (bool)e.Value; StateHasChanged(); })">
                        <label class="form-check-label flex-grow-1" for="showFootnotesSwitch">
                            @TransliterationService.GetDisplayText("Изоҳларни кўрсатиш")
                        </label>
                    </div>
                </div>
                
                <small class="text-muted text-center mt-3 px-2">
                    @TransliterationService.GetDisplayText("Камида арабча ёки таржима кўрсатилиши керак")
                </small>
            </div>
            
            <div class="vstack border-3 p-2 m-2 my-3 rounded-pill bg-light bg-gradient shadow-sm">
                <h5 class="card-title text-primary text-center mb-3">@TransliterationService.GetDisplayText("Таржима янгиланишлари")</h5>
                
                @if (!string.IsNullOrEmpty(updateMessage))
                {
                    <div class="alert alert-info rounded-pill text-center mb-3" role="alert">
                        @updateMessage
                    </div>
                }
                
                @if (isUpdating)
                {
                    <div class="vstack gap-2 mb-3">
                        <div class="progress" style="height: 30px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: @(updateProgress)%"
                                 aria-valuenow="@updateProgress" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                                @updateProgress%
                            </div>
                        </div>
                    </div>
                }
                
                <button class="btn btn-primary rounded-pill w-100 py-3" 
                        @onclick="CheckForUpdates" 
                        disabled="@(isCheckingUpdate || isUpdating)">
                    @if (isCheckingUpdate)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <span class="icon-mask icon-update svg-icon-md me-2" aria-hidden="true" title="Update"></span>
                    }
                    @TransliterationService.GetDisplayText("Янгиланишларни текшириш")
                </button>
                
                @{
                    var currentVersion = updateService?.GetCurrentDatabaseVersion() ?? "1.3";
                }
                <small class="text-muted text-center mt-2">
                    @TransliterationService.GetDisplayText("Жорий версия"): @currentVersion
                </small>
            </div>

            <div class="vstack border-3 p-2 m-2 my-3 rounded-pill bg-light bg-gradient shadow-sm">
                <h5 class="card-title text-primary text-center mb-3">@TransliterationService.GetDisplayText("Маълумотларни бошқариш")</h5>
                
                <button class="btn btn-primary rounded-pill w-100 py-3 mb-3" @onclick="ImportData" disabled="@isImporting">
                    @if (isImporting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <span class="icon-mask icon-import svg-icon-md me-2" aria-hidden="true" title="Import"></span>
                    }
                    @TransliterationService.GetDisplayText("Заҳирадан тиклаш")
                </button>
                <small class="text-muted text-center mb-3">@TransliterationService.GetDisplayText("Олдинги заҳира файлини юклаш")</small>
                
                <button class="btn btn-primary rounded-pill w-100 py-3" @onclick="ExportData" disabled="@isExporting">
                    @if (isExporting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <span class="icon-mask icon-export svg-icon-md me-2" aria-hidden="true" title="Export"></span>
                    }
                    @TransliterationService.GetDisplayText("Қайдларни заҳиралаш")
                </button>
                <small class="text-muted text-center mt-2">@TransliterationService.GetDisplayText("Қайдларингизни файлга сақлаш")</small>
            </div>
        </div>
    </div>
</div>
