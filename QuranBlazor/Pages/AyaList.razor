@page "/ayalist"
@using QuranBlazor.Data
@using System.Diagnostics.Tracing
@using System.Text.RegularExpressions
@using System.Diagnostics
@inject DbContext db
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject DialogService Dialog
@implements IDisposable

@code {
    // Handles URL patterns like /search?filter=some+stuff&page=3&assignee=Monica&assignee=Chandler
    [Parameter]
    [SupplyParameterFromQuery]
    public int SuraId { get; set; }

    public string SuraName { get; set; }
    private string arabicStyle => $"font-size:{Preferences.Get("ArabicFontSize", 16)}px";
    private string textStyle => $"font-size:{Preferences.Get("TranslateFontSize", 14)}px";
    private string commentStyle => $"font-size:{Preferences.Get("CommentFontSize", 12)}px;margin-bottom:0px";
    private string bookmarkAya = Preferences.Get("Bookmark", "49:11");
    private bool isDataLoaded;
    private bool isLoading = true;
    private string errorMessage;
    private bool preventScrollToFragment;
    public IEnumerable<Aya> Ayas { get; set; }
    private int _currentSuraIdForPage;
    private string _previousFragment = string.Empty;
    private bool _justUpdatedUrlFragment = false;
    private IDisposable _locationChangingHandler;

    private async ValueTask Favorite(Aya aya)
    {
        preventScrollToFragment = true; // Set the flag when Favorite is called
        aya.IsFavorite = !aya.IsFavorite;
        await db.UpdateAyaAsync(aya);
        Dialog.DisplayToast(TransliterationService.GetDisplayText("Оят белгиланди"));
    }

    private async Task Bookmark(Aya aya)
    {
        preventScrollToFragment = true; // Set the flag when Bookmark is called
        Preferences.Set("Bookmark", aya.SuraId + ":" + aya.AyaId);
        bookmarkAya = aya.SuraId + ":" + aya.AyaId;
        Dialog.DisplayToast(TransliterationService.GetDisplayText("Сўнги ўқиган оятингиз деб белгиланди"));
    }

    private async Task NoteAsync(Aya aya)
    {
        preventScrollToFragment = true; // Set the flag when Note is called
        if (aya.HasNote)
        {
            var confirmed = await Dialog.DisplayAlert(TransliterationService.GetDisplayText("Огоҳлантириш"), TransliterationService.GetDisplayText("Бу оят учун аллақачон эслатма қўшилган, агар давом этсангиз эски эслатма ўчирилади, уни ўчириб ташламоқчимисиз?"), TransliterationService.GetDisplayText("Ҳа, эскисини ўчириб ташланг"), TransliterationService.GetDisplayText("Йўқ")).ConfigureAwait(false);
            if (!confirmed) return;
            aya.HasNote = false;
            await db.UpdateAyaAsync(aya).ConfigureAwait(false);
            var result = await db.DeleteNoteAsync(aya.AyaId, aya.SuraId);
            if (result > 0) MainThread.BeginInvokeOnMainThread(() => Dialog.DisplayToast(TransliterationService.GetDisplayText("Оят қайди ўчирилди")));
        }
        else
        {
            var note = await Dialog.DisplayPrompt(TransliterationService.GetDisplayText("Эслатма қўшинг"), TransliterationService.GetDisplayText("Оятга эслатма қўшинг"), TransliterationService.GetDisplayText("Қўшиш"), TransliterationService.GetDisplayText("Ёпиш")).ConfigureAwait(false);
            if (string.IsNullOrEmpty(note)) return;
            var result = await db.AddNoteAsync(aya.AyaId, aya.SuraId, SuraName, note);
            aya.HasNote = true;
            // await db.UpdateAyaAsync(aya).ConfigureAwait(false);
            if (result > 0) MainThread.BeginInvokeOnMainThread(() => Dialog.DisplayToast(TransliterationService.GetDisplayText("Оят эслатмаси қўшилди")));
        }

    }


    protected override async Task OnInitializedAsync()
    {
        _currentSuraIdForPage = SuraId;
        _previousFragment = new Uri(NavigationManager.Uri, UriKind.Absolute).Fragment;
        NavigationManager.LocationChanged += HandleLocationChanged;
        // Replaced OnBeforeInternalNavigation with RegisterLocationChangingHandler
        _locationChangingHandler = NavigationManager.RegisterLocationChangingHandler(HandleBeforeInternalNavigation);
        // NavigationManager.OnBeforeInternalNavigation += HandleBeforeInternalNavigation;
        // No StateHasChanged needed here typically, OnParametersSetAsync will handle initial data load.
        // //await LoadDataIfNeededAsync();
        // NavigationManager.LocationChanged += OnLocationChanged;
        // await InvokeAsync(StateHasChanged);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_currentSuraIdForPage != SuraId || !isDataLoaded) // Load if SuraId changed or data not yet loaded
        {
            isDataLoaded = false; // Reset flag if SuraId changes
            await LoadDataAsync();
            _currentSuraIdForPage = SuraId;
        }
        // No base.OnParametersSetAsync() call needed if fully handling logic here.
        // await LoadDataAsync();
        // await base.OnParametersSetAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = null; // Clear previous errors
        isDataLoaded = false; // Reset data loaded flag
        try
        {
            Ayas = await db.GetAyaListAsync(SuraId).ConfigureAwait(false);
            SuraName = await db.GetSuraNameAsync(SuraId).ConfigureAwait(false);
            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load data. Please try again later.";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isDataLoaded && !isLoading) // Ensure data is loaded and not in a loading state
        {
            var uri = new Uri(NavigationManager.Uri, UriKind.Absolute);
            var fragment = uri.Fragment;

            if (!preventScrollToFragment)
            {
                if (!string.IsNullOrEmpty(fragment) && fragment.StartsWith('#'))
                {
                    Debug.WriteLine($"OnAfterRenderAsync: Attempting to scroll to fragment: {fragment}");
                    await ScrollToFragment();
                }
                else
                {
                    Debug.WriteLine("OnAfterRenderAsync: No fragment, attempting to restore general scroll position (restoreScrollPosition).");
                    await JsRuntime.InvokeVoidAsync("restoreScrollPosition");
                }
            }

            if (firstRender)
            {
                // This JavaScript sets up an event listener on the window to save scroll position
                // before the user navigates away from the page.
                await JsRuntime.InvokeVoidAsync("eval", @"
                    window.addEventListener('beforeunload', function() {
                        saveScrollPosition();
                        console.log('beforeunload: Scroll position saved.');
                    });
                ");
                Debug.WriteLine("OnAfterRenderAsync: Attached beforeunload listener for saving scroll position.");
            }
        }
        preventScrollToFragment = false; // Reset flag after potential scroll operations
    }

    private async ValueTask HandleBeforeInternalNavigation(LocationChangingContext context)
    {
        var currentUri = new Uri(NavigationManager.Uri, UriKind.Absolute);
        // Only act if we are on an AyaList page
        if (currentUri.AbsolutePath.EndsWith("/ayalist", StringComparison.OrdinalIgnoreCase))
        {
            Debug.WriteLine($"OnBeforeInternalNavigation from {NavigationManager.Uri} to {context.TargetLocation}. Attempting to set fragment for current URL if needed.");
            // This JS call is fire-and-forget in terms of Blazor's sync lifecycle for this event.
            // history.replaceState is synchronous, so it should be fine.
            await JsRuntime.InvokeVoidAsync("updateUrlWithTopVisibleAyaFragmentForAyaList");
            _justUpdatedUrlFragment = true; // Indicate that a fragment might have been set
        }
    }

    private void HandleLocationChanged(object sender, LocationChangedEventArgs e)
    {
        var newUri = new Uri(e.Location, UriKind.Absolute);
        var newFragment = newUri.Fragment;

        var newQuery = QueryHelpers.ParseQuery(newUri.Query);
        newQuery.TryGetValue("SuraId", out var newSuraIdStr);
        int.TryParse(newSuraIdStr.ToString(), out int newSuraIdFromQuery);

        // If SuraId is the same, but fragment changed, we need to re-render for OnAfterRenderAsync to pick up the scroll.
        // If SuraId changes, OnParametersSetAsync will handle data loading, then OnAfterRenderAsync will scroll.
        if (newSuraIdFromQuery == _currentSuraIdForPage && newFragment != _previousFragment)
        {
            Debug.WriteLine($"HandleLocationChanged: Fragment changed for SuraId {newSuraIdFromQuery}. Triggering StateHasChanged.");
            InvokeAsync(StateHasChanged);
        }

        _previousFragment = newFragment;
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= HandleLocationChanged;
        _locationChangingHandler?.Dispose();
        // NavigationManager.OnBeforeInternalNavigation -= HandleBeforeInternalNavigation;
    }

    // private async void OnLocationChanged(object sender, LocationChangedEventArgs e)
    // {
    //     var newUri = new Uri(e.Location, UriKind.Absolute);
    //     var oldUri = new Uri(NavigationManager.Uri, UriKind.Absolute);

    //     // Check if it's an internal navigation (same page, different fragment or query for SuraId)
    //     if (newUri.AbsolutePath == oldUri.AbsolutePath)
    //     {
    //         var newQuery = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(newUri.Query);
    //         var oldQuery = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(oldUri.Query);

    //         newQuery.TryGetValue("SuraId", out var newSuraIdStr);
    //         oldQuery.TryGetValue("SuraId", out var oldSuraIdStr);

    //         if (newSuraIdStr.ToString() == oldSuraIdStr.ToString() && newUri.Fragment != oldUri.Fragment && !string.IsNullOrEmpty(newUri.Fragment))
    //         {
    //             _isNavigatingInternally = true; // Navigating to a fragment within the same Sura
    //         }
    //         else if (newSuraIdStr.ToString() != oldSuraIdStr.ToString())
    //         {
    //             _isNavigatingInternally = true; // Navigating to a different Sura via comment link
    //         }
    //     }
    //     if (!preventScrollToFragment)
    //     {
    //         await ScrollToFragment();
    //     }
    //     preventScrollToFragment = false; // Reset the flag after each render
    //     if (!preventScrollToFragment && newUri.Fragment.StartsWith('#'))
    //     {
    //         // This will be handled by OnAfterRenderAsync after data is loaded for the new SuraId/fragment
    //     }
    //     else if (!preventScrollToFragment && !_isNavigatingInternally)
    //     {
    //         // If not scrolling to a fragment and not an internal navigation (e.g. browser back to a non-fragment URL)
    //         // We might want to restore scroll. This is also handled in OnAfterRenderAsync.
    //     }

    //     // Data loading for new SuraId (if changed) is handled by OnParametersSetAsync.
    //     // We need to ensure StateHasChanged is called if parameters don't trigger it automatically
    //     // or if we need an immediate UI update based on location change.
    //     await InvokeAsync(StateHasChanged); // Ensure UI updates if needed
    // }

    private async Task ScrollToFragment()
    {
        var uri = new Uri(NavigationManager.Uri, UriKind.Absolute);
        var fragment = uri.Fragment;
        if (!string.IsNullOrEmpty(fragment) && fragment.StartsWith('#'))
        {
            var elementId = fragment.Substring(1);

            if (!string.IsNullOrEmpty(elementId))
            {
                await Task.Delay(500);
                await JsRuntime.InvokeVoidAsync("BlazorScrollToId", elementId);
            }
        }
    }
    private async Task BackToTop()
    {
        preventScrollToFragment = true; // Set the flag when BackToTop is called
        await JsRuntime.InvokeVoidAsync("BlazorScrollToTop");
        StateHasChanged();
    }

    string AyaFilter;
    private void FilterAya()
    {
        bool toLatin = Preferences.Get("UzbekScript", "Cyrillic") == "Latin";
        string filterTerm = AyaFilter; // Assuming filter term matches current display script
        Ayas = Ayas.Where(a =>
        {
            string text = toLatin ? TransliterationService.ToLatin(a.Text) : a.Text;
            string comment = (a.Comment != null) ? (toLatin ? TransliterationService.ToLatin(a.Comment) : a.Comment) : null;
            bool textMatch = text?.IndexOf(filterTerm, StringComparison.InvariantCultureIgnoreCase) >= 0;
            bool commentMatch = comment?.IndexOf(filterTerm, StringComparison.InvariantCultureIgnoreCase) >= 0;
            return textMatch || commentMatch;
        }).ToList();

        StateHasChanged(); // Notify Blazor that the data has changed
        //a.Text.Contains(AyaFilter, StringComparison.InvariantCultureIgnoreCase) || (a.Comment != null && a.Comment.Contains(AyaFilter, StringComparison.InvariantCultureIgnoreCase))).ToList();
    }

    private string StripHtml(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        // First, remove HTML tags
        var noHtmlTags = Regex.Replace(input, "<.*?>", string.Empty);
        // Then, decode HTML entities
        return System.Net.WebUtility.HtmlDecode(noHtmlTags);
    }

    private async Task ShareAya(Aya aya)
    {
        string suraNameDisplay = TransliterationService.GetDisplayText(SuraName);
        string ayaTextDisplay = TransliterationService.GetDisplayText(aya.Text);
        string plainCommentDisplay = TransliterationService.GetDisplayText(StripHtml(aya.Comment));
        string titlePart1 = TransliterationService.GetDisplayText("Оят:");
        string titlePart2 = TransliterationService.GetDisplayText("сураси,");
        string titlePart3 = TransliterationService.GetDisplayText(". ояти");
        string title = $"{titlePart1} {suraNameDisplay} {titlePart2} {aya.AyaId}{titlePart3}";//$"Оят: {SuraName} сураси, {aya.AyaId}. ояти";
        //string plainComment=StripHtml(aya.Comment);
        await Share.Default.RequestAsync(new ShareTextRequest
            {
                Title = title,
                Text = $"{title}\n{aya.Arabic}\n{ayaTextDisplay}\n{plainCommentDisplay}",
                Uri = "https://www.musulmonlar.com"
            });
    }


    private string ProcessComment(string cyrillicCommentFromDb)
    {
        if (string.IsNullOrEmpty(cyrillicCommentFromDb)) return string.Empty;

        var regex = new Regex(@"\(([^)]+)\)");
        bool toLatin = Preferences.Get("UzbekScript", "Cyrillic") == "Latin";
        var resultHtml = new System.Text.StringBuilder();
        int lastIndex = 0;

        try
        {
            foreach (Match match in regex.Matches(cyrillicCommentFromDb))
            {
                // Append the text segment before this match, transliterated
                string textBeforeMatch = cyrillicCommentFromDb.Substring(lastIndex, match.Index - lastIndex);
                resultHtml.Append(toLatin ? TransliterationService.ToLatin(textBeforeMatch) : textBeforeMatch);

                // Process the matched part (the link pattern)
                // match.Groups[1].Value is the Cyrillic text inside parentheses
                var commentPartsInParentheses = match.Groups[1].Value.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries);
                var processedLinkParts = new List<string>();

                foreach (var partContentCyrillic in commentPartsInParentheses) // partContent is Cyrillic, e.g., "Мўминун 23:70"
                {
                    var trimmedCyrillicPart = partContentCyrillic.Trim(); // Still Cyrillic

                    // This is the text that will be displayed for the link. Convert it to the target script.
                    string linkDisplayTextInTargetScript = toLatin ? TransliterationService.ToLatin(trimmedCyrillicPart) : trimmedCyrillicPart;

                    // Parse SuraId and AyaId from the original Cyrillic trimmedPart
                    var subParts = trimmedCyrillicPart.Split(new[] { ':' }, StringSplitOptions.RemoveEmptyEntries);
                    if (subParts.Length == 2 && subParts[0].Trim().Contains(' '))
                    {
                        var suraDetailsParts = subParts[0].Trim().Split(' ');
                        var suraIdStr = suraDetailsParts.Last();
                        var ayaNumStr = subParts[1].Trim().Split('-')[0];

                        if (int.TryParse(suraIdStr, out int parsedSuraId) && int.TryParse(ayaNumStr, out int parsedAyaId))
                        {
                            // Construct the link with ASCII HTML tags and the already-scripted linkDisplayText
                            processedLinkParts.Add($"<a href=\"/AyaList?SuraId={parsedSuraId}#{parsedAyaId}\">{linkDisplayTextInTargetScript}</a>");
                        }
                        else
                        {
                            processedLinkParts.Add(linkDisplayTextInTargetScript); // Fallback if parsing fails
                        }
                    }
                    else
                    {
                        processedLinkParts.Add(linkDisplayTextInTargetScript); // Fallback if not in "SuraName SuraId:AyaId" format
                    }
                }
                resultHtml.Append($"({string.Join(", ", processedLinkParts)})");

                lastIndex = match.Index + match.Length;
            }

            // Append the rest of the string (if any) after the last match, transliterated
            string remainingText = cyrillicCommentFromDb.Substring(lastIndex);
            resultHtml.Append(toLatin ? TransliterationService.ToLatin(remainingText) : remainingText);

            return resultHtml.ToString();
        }
        catch (Exception exception)
        {
            Console.Error.WriteLine($"Error processing comment in AyaList: {exception.Message}");
            // Fallback: return original comment, transliterated to the target script if possible (assuming it's plain text)
            return toLatin ? TransliterationService.ToLatin(cyrillicCommentFromDb) : cyrillicCommentFromDb;
        }
    }
}
<div class="text-white mb-3">
    @*  form-floating *@
    <input class="form-control me-2 rounded-pill primary-color p-3" id="floatingSearch" type="search" placeholder="@TransliterationService.GetDisplayText(" Оят Излаш")" @bind="AyaFilter" @bind:event="oninput" @bind:after="FilterAya" aria-label="Оят Излаш">
    @* <label class="primary-color" for="floatingSearch">Оят Излаш</label> *@
</div>

<div class="text-center vstack shadow-lg bg-light bg-gradient rounded-pill" id="surahead">
    <h3 class="pt-3 pb-0 text-black">@SuraId. @TransliterationService.GetDisplayText(SuraName) @TransliterationService.GetDisplayText(" сураси")</h3>
    @if (SuraId is not (1 or 9))
    {
        <span class="text-center arabic mx-auto fs-2 pb-2 pt-0">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</span>
    }
</div>
@if (isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger text-center">@errorMessage</div>
}
else
{
    @if (Ayas != null)
    {
        @foreach (Aya aya in Ayas)
        {
            <div class="row my-3" id="@aya.AyaId">
                <div class="col">
                    <div class="card bg-light bg-gradient rounded-pill">
                        <div class="card-body">
                            <div class="vstack">
                                <h5 class="card-title header-bg-color bg-gradient hstack rounded-3 gap-3 text-white ">
                                    <span class="bg-gradient border-3 rounded-2 shadow-lg me-auto p-2 ms-1">@aya.AyaId</span>
                                    <span title="оятни баҳам кўринг" aria-hidden="true" @onclick="async () => await ShareAya(aya)"><img src="share_white.png" width="28" height="28" alt="оятни баҳам кўринг" /></span>
                                    <span class="text-white" title="Оятни белгилаш" aria-hidden="true" @onclick="async () => await Favorite(aya)"><img src="@(aya.IsFavorite ? "heart_check_white.png" : "heart_plus_white.png")" width="28" height="28" alt="Оятни белгилаш" /></span>
                                    <span title="Эслатма қўшинг" aria-hidden="true" @onclick="() => NoteAsync(aya)"><img src="@(aya.HasNote ? "note_alt_white.png" : "add_notes_white.png")" width="28" height="28" alt="Эслатма қўшинг" /></span>
                                    <span class="me-3" title="Сўнг ўқилган оят деб белгилаш" aria-hidden="true" @onclick="() => Bookmark(aya)"><img src="@((SuraId + ":" + aya.AyaId == bookmarkAya) ? "bookmark_added_white.png" : "bookmark_add_white.png")" width="28" height="28" alt="Сўнг ўқилган оят деб белгилаш" /></span>
                                </h5>
                                <p class="arabic mb-0 me-2 " style=@arabicStyle>@aya.Arabic</p>
                                @if (string.IsNullOrEmpty(AyaFilter))
                                {
                                    <p class="my-2" style=@textStyle>@((MarkupString)TransliterationService.GetDisplayText(aya.Text))</p>
                                    if (aya.Comment != null)
                                    {
                                        <hr />
                                        <p style=@commentStyle>@((MarkupString)ProcessComment(aya.Comment))</p>
                                    }
                                }
                                else
                                {
                                    <p class="my-2" style=@textStyle>
                                        @((MarkupString)TransliterationService.GetDisplayText(aya.Text).Replace(AyaFilter, "<span class='search-term'>" + AyaFilter + "</span>", StringComparison.OrdinalIgnoreCase))
                                    </p>
                                    @if (aya.Comment != null)
                                    {
                                        <hr />
                                        <p style=@commentStyle>
                                            @((MarkupString)ProcessComment(aya.Comment).Replace(AyaFilter, "<span class='search-term'>" + AyaFilter + "</span>", StringComparison.OrdinalIgnoreCase))
                                        </p>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    <div id="BackToTop" class="Shown" @onclick="BackToTop"></div>
}