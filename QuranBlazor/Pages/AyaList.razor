@page "/ayalist"
@using QuranBlazor.Data
@using System.Diagnostics.Tracing
@using System.Text.RegularExpressions
@using System.Diagnostics
@using QuranBlazor.Services
@inject DbContext db
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject DialogService Dialog
@implements IDisposable

@code {
    // Handles URL patterns like /search?filter=some+stuff&page=3&assignee=Monica&assignee=Chandler
    [Parameter]
    [SupplyParameterFromQuery]
    public int SuraId { get; set; }

    public string SuraName { get; set; }
    private int arabicFontSize;
    private int translateFontSize;
    private int commentFontSize;
    private string arabicStyle => $"font-size:{arabicFontSize}px";
    private string textStyle => $"font-size:{translateFontSize}px";
    private string commentStyle => $"font-size:{commentFontSize}px;margin-bottom:0px";
    private string bookmarkAya = Preferences.Get(PreferenceKeys.Bookmark, PreferenceKeys.DefaultBookmark);
    
    // Display preferences
    private bool showArabicText;
    private bool showTranslation;
    private bool showFootnotes;
    private bool isDataLoaded;
    private bool isLoading = true;
    private string errorMessage;
    private List<Aya> Ayas { get; set; } = new();
    private List<Aya> AllAyas { get; set; } = new();
    private int _currentSuraIdForPage;
    private string _pendingScrollFragment = null;
    private IDisposable _locationChangingHandler;
    private Dictionary<string, string> _processedCommentsCache = new();
    private DebounceTimer _filterDebounceTimer;
    private bool _isLatinScriptPreferred;
    private bool _scrollSaverRegistered;

    private static readonly Regex CommentLinkRegex = new(@"\(([^)]+)\)", RegexOptions.Compiled);

    // Bookmark Collections
    private bool showCollectionsDialog = false;
    private Aya selectedAyaForCollection;
    private List<BookmarkCollection> availableCollections;
    private HashSet<int> ayaCollections = new();
    private string newCollectionName = string.Empty;
    private bool showCreateNewInDialog = false;

    private async Task Bookmark(Aya aya)
    {
        var bookmarkValue = $"{aya.SuraId}:{aya.AyaId}";
        Preferences.Set(PreferenceKeys.Bookmark, bookmarkValue);
        bookmarkAya = bookmarkValue;
        await Dialog.DisplayToast(TransliterationService.GetDisplayText("Сўнги ўқиган оятингиз деб белгиланди"));
    }

    private async Task NoteAsync(Aya aya)
    {
        if (aya.HasNote)
        {
            var confirmed = await Dialog.DisplayAlert(TransliterationService.GetDisplayText("Огоҳлантириш"), TransliterationService.GetDisplayText("Бу оят учун аллақачон эслатма қўшилган, агар давом этсангиз эски эслатма ўчирилади, уни ўчириб ташламоқчимисиз?"), TransliterationService.GetDisplayText("Ҳа, эскисини ўчириб ташланг"), TransliterationService.GetDisplayText("Йўқ")).ConfigureAwait(false);
            if (!confirmed) return;
            aya.HasNote = false;
            await db.UpdateAyaAsync(aya).ConfigureAwait(false);
            var result = await db.DeleteNoteAsync(aya.AyaId, aya.SuraId);
            if (result > 0)
            {
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Оят қайди ўчирилди"));
            }
        }
        else
        {
            var note = await Dialog.DisplayPrompt(TransliterationService.GetDisplayText("Эслатма қўшинг"), TransliterationService.GetDisplayText("Оятга эслатма қўшинг"), TransliterationService.GetDisplayText("Қўшиш"), TransliterationService.GetDisplayText("Ёпиш")).ConfigureAwait(false);
            if (string.IsNullOrEmpty(note)) return;
            var result = await db.AddNoteAsync(aya.AyaId, aya.SuraId, SuraName, note);
            aya.HasNote = true;
            // await db.UpdateAyaAsync(aya).ConfigureAwait(false);
            if (result > 0)
            {
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Оят эслатмаси қўшилди"));
            }
        }

    }

    private async Task ShowCollectionsDialog(Aya aya)
    {
        selectedAyaForCollection = aya;
        
        try
        {
            availableCollections = await db.GetBookmarkCollectionsAsync();
            var collections = await db.GetCollectionsForAyaAsync(aya.SuraId, aya.AyaId);
            ayaCollections = new HashSet<int>(collections.Select(c => c.Id));
            showCollectionsDialog = true;
            showCreateNewInDialog = false;
            newCollectionName = string.Empty;
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error loading collections: {ex.Message}");
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Хатолик юз берди"));
        }
    }

    private void CloseCollectionsDialog()
    {
        showCollectionsDialog = false;
        selectedAyaForCollection = null;
        availableCollections = null;
        ayaCollections.Clear();
        showCreateNewInDialog = false;
        newCollectionName = string.Empty;
    }

    private void ShowCreateNewCollection()
    {
        showCreateNewInDialog = true;
    }

    private void CancelCreateNewCollection()
    {
        showCreateNewInDialog = false;
        newCollectionName = string.Empty;
    }

    private async Task CreateAndAddToNewCollection()
    {
        if (string.IsNullOrWhiteSpace(newCollectionName))
        {
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Илтимос, тўплам номини киритинг"));
            return;
        }

        try
        {
            // Create new collection
            var newCollection = new BookmarkCollection
            {
                Name = newCollectionName,
                CreatedDate = DateTime.Now
            };
            
            var collectionId = await db.AddBookmarkCollectionAsync(newCollection);
            if (collectionId <= 0)
            {
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Бу ном билан тўплам аллақачон мавжуд"));
                return;
            }
            
            // Add current aya to the new collection
            if (selectedAyaForCollection != null)
            {
                await db.AddAyaToCollectionAsync(selectedAyaForCollection.Id, collectionId);
            }
            
            // Reload collections to show the new one
            availableCollections = await db.GetBookmarkCollectionsAsync();
            var collections = await db.GetCollectionsForAyaAsync(selectedAyaForCollection.SuraId, selectedAyaForCollection.AyaId);
            ayaCollections = new HashSet<int>(collections.Select(c => c.Id));
            
            // Update IsFavorite flag
            selectedAyaForCollection.IsFavorite = ayaCollections.Count > 0;
            await db.UpdateAyaAsync(selectedAyaForCollection);
            
            showCreateNewInDialog = false;
            newCollectionName = string.Empty;
            
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Янги тўплам яратилди ва оят қўшилди"));
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error creating collection: {ex.Message}");
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Хатолик юз берди"));
        }
    }

    private async Task ToggleCollection(int collectionId)
    {
        if (selectedAyaForCollection == null) return;

        try
        {
            if (ayaCollections.Contains(collectionId))
            {
                await db.RemoveAyaFromCollectionAsync(selectedAyaForCollection.Id, collectionId);
                ayaCollections.Remove(collectionId);
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Тўпламдан олиб ташланди"));
            }
            else
            {
                await db.AddAyaToCollectionAsync(selectedAyaForCollection.Id, collectionId);
                ayaCollections.Add(collectionId);
                await Dialog.DisplayToast(TransliterationService.GetDisplayText("Тўпламга қўшилди"));
            }
            
            // Update IsFavorite flag based on whether aya is in any collection
            selectedAyaForCollection.IsFavorite = ayaCollections.Count > 0;
            await db.UpdateAyaAsync(selectedAyaForCollection);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"Error toggling collection: {ex.Message}");
            await Dialog.DisplayToast(TransliterationService.GetDisplayText("Хатолик юз берди"));
        }
    }


    protected override async Task OnInitializedAsync()
    {
        _filterDebounceTimer = new DebounceTimer(250);
        _currentSuraIdForPage = SuraId;
        _isLatinScriptPreferred = TransliterationService.IsLatinScriptSelected;
        
        // Load font sizes
        arabicFontSize = FontSizeService.GetArabicFontSize();
        translateFontSize = FontSizeService.GetTranslateFontSize();
        commentFontSize = FontSizeService.GetCommentFontSize();
        
        // Load display preferences
        showArabicText = Preferences.Get(PreferenceKeys.ShowArabicText, true);
        showTranslation = Preferences.Get(PreferenceKeys.ShowTranslation, true);
        showFootnotes = Preferences.Get(PreferenceKeys.ShowFootnotes, true);
        
        // Ensure at least one text type is visible
        if (!showArabicText && !showTranslation)
        {
            showArabicText = true;
            Preferences.Set(PreferenceKeys.ShowArabicText, true);
        }
        
        // Subscribe to events
        TransliterationService.OnScriptChanged += HandleScriptChanged;
        FontSizeService.OnFontSizeChanged += HandleFontSizeChanged;
        
        // Register navigation handler to save scroll position before leaving
        _locationChangingHandler = NavigationManager.RegisterLocationChangingHandler(OnLocationChanging);
    }

    private async ValueTask OnLocationChanging(LocationChangingContext context)
    {
        // Save current scroll position before navigation
        var currentUri = new Uri(NavigationManager.Uri, UriKind.Absolute);
        
        // Only save if we're currently on the AyaList page
        if (currentUri.AbsolutePath.EndsWith("/ayalist", StringComparison.OrdinalIgnoreCase))
        {
            try
            {
                await JsRuntime.InvokeVoidAsync("saveScrollPosition");
                Debug.WriteLine($"Saved scroll position before navigating from {NavigationManager.Uri}");
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error saving scroll position: {ex.Message}");
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (_currentSuraIdForPage != SuraId || !isDataLoaded)
        {
            // Store the fragment we need to scroll to after loading
            var uri = new Uri(NavigationManager.Uri, UriKind.Absolute);
            _pendingScrollFragment = uri.Fragment;
            
            await LoadDataAsync();
            _currentSuraIdForPage = SuraId;
        }
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        errorMessage = null;
        isDataLoaded = false;
        try
        {
            _processedCommentsCache.Clear();
            AllAyas = await db.GetAyaListAsync(SuraId).ConfigureAwait(false);
            Ayas = AllAyas;
            SuraName = await db.GetSuraNameAsync(SuraId).ConfigureAwait(false);
            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load data. Please try again later.";
            Console.Error.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Ensure click handlers are attached after render (needed for dynamically rendered content)
        if (isDataLoaded && !isLoading && !_scrollSaverRegistered)
        {
            try
            {
                await JsRuntime.InvokeVoidAsync("quranScrollInterop.registerAyaListLinkSaver");
                _scrollSaverRegistered = true;
            }
            catch (Exception ex)
            {
                Debug.WriteLine($"Error setting up link handlers: {ex.Message}");
            }
        }
        
        if (isDataLoaded && !isLoading && !string.IsNullOrEmpty(_pendingScrollFragment))
        {
            var fragment = _pendingScrollFragment;
            _pendingScrollFragment = null; // Clear it so we don't scroll again
            
            if (fragment.StartsWith('#'))
            {
                var elementId = fragment.Substring(1);
                
                // First, try to restore saved position (from browser back)
                var uri = new Uri(NavigationManager.Uri, UriKind.Absolute);
                var urlWithFragment = uri.GetLeftPart(UriPartial.Query) + fragment;
                Debug.WriteLine($"Checking for saved position at: {urlWithFragment}");
                
                try
                {
                    // Check if we have a saved position for this exact URL
                    var hasSavedPosition = await JsRuntime.InvokeAsync<bool>(
                        "quranScrollInterop.hasSavedPosition",
                        urlWithFragment);
                    
                    if (hasSavedPosition)
                    {
                        // Browser back navigation - restore exact position
                        Debug.WriteLine($"Found saved position, restoring...");
                        await Task.Delay(100);
                        await JsRuntime.InvokeVoidAsync("restoreScrollPosition");
                    }
                    else
                    {
                        // Forward navigation (clicked link) - scroll to element
                        Debug.WriteLine($"No saved position, scrolling to element: {elementId}");
                        
                        bool scrolled = false;
                        for (int attempt = 0; attempt < 5 && !scrolled; attempt++)
                        {
                            await Task.Delay(100 + (attempt * 100));
                            scrolled = await JsRuntime.InvokeAsync<bool>("tryScrollToElement", elementId);
                            if (scrolled)
                            {
                                Debug.WriteLine($"Successfully scrolled to {elementId} on attempt {attempt + 1}");
                                break;
                            }
                        }
                        
                        if (!scrolled)
                        {
                            Debug.WriteLine($"Failed to scroll to {elementId} after 5 attempts");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"Error in scroll logic: {ex.Message}");
                }
            }
            else
            {
                // No fragment, restore previous scroll position
                await JsRuntime.InvokeVoidAsync("restoreScrollPosition");
            }
        }
    }



    private void HandleScriptChanged()
    {
        _isLatinScriptPreferred = TransliterationService.IsLatinScriptSelected;
        _processedCommentsCache.Clear();
        InvokeAsync(StateHasChanged);
    }

    private void HandleFontSizeChanged()
    {
        arabicFontSize = FontSizeService.GetArabicFontSize();
        translateFontSize = FontSizeService.GetTranslateFontSize();
        commentFontSize = FontSizeService.GetCommentFontSize();
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        TransliterationService.OnScriptChanged -= HandleScriptChanged;
        FontSizeService.OnFontSizeChanged -= HandleFontSizeChanged;
        _locationChangingHandler?.Dispose();
        _filterDebounceTimer?.Dispose();
    }

    // private async void OnLocationChanged(object sender, LocationChangedEventArgs e)
    // {
    //     var newUri = new Uri(e.Location, UriKind.Absolute);
    //     var oldUri = new Uri(NavigationManager.Uri, UriKind.Absolute);

    //     // Check if it's an internal navigation (same page, different fragment or query for SuraId)
    //     if (newUri.AbsolutePath == oldUri.AbsolutePath)
    //     {
    //         var newQuery = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(newUri.Query);
    //         var oldQuery = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(oldUri.Query);

    //         newQuery.TryGetValue("SuraId", out var newSuraIdStr);
    //         oldQuery.TryGetValue("SuraId", out var oldSuraIdStr);

    //         if (newSuraIdStr.ToString() == oldSuraIdStr.ToString() && newUri.Fragment != oldUri.Fragment && !string.IsNullOrEmpty(newUri.Fragment))
    //         {
    //             _isNavigatingInternally = true; // Navigating to a fragment within the same Sura
    //         }
    //         else if (newSuraIdStr.ToString() != oldSuraIdStr.ToString())
    //         {
    //             _isNavigatingInternally = true; // Navigating to a different Sura via comment link
    //         }
    //     }
    //     if (!preventScrollToFragment)
    //     {
    //         await ScrollToFragment();
    //     }
    //     preventScrollToFragment = false; // Reset the flag after each render
    //     if (!preventScrollToFragment && newUri.Fragment.StartsWith('#'))
    //     {
    //         // This will be handled by OnAfterRenderAsync after data is loaded for the new SuraId/fragment
    //     }
    //     else if (!preventScrollToFragment && !_isNavigatingInternally)
    //     {
    //         // If not scrolling to a fragment and not an internal navigation (e.g. browser back to a non-fragment URL)
    //         // We might want to restore scroll. This is also handled in OnAfterRenderAsync.
    //     }

    //     // Data loading for new SuraId (if changed) is handled by OnParametersSetAsync.
    //     // We need to ensure StateHasChanged is called if parameters don't trigger it automatically
    //     // or if we need an immediate UI update based on location change.
    //     await InvokeAsync(StateHasChanged); // Ensure UI updates if needed
    // }

    private async Task BackToTop()
    {
        await JsRuntime.InvokeVoidAsync("BlazorScrollToTop");
    }

    string AyaFilter;
    private void FilterAya()
    {
        if (AllAyas == null || _filterDebounceTimer == null)
        {
            return;
        }

        _filterDebounceTimer?.Debounce(async () =>
        {
            if (string.IsNullOrWhiteSpace(AyaFilter))
            {
                Ayas = AllAyas;
            }
            else
            {
                string filterTerm = AyaFilter.Trim();
                var comparison = StringComparison.OrdinalIgnoreCase;
                bool looksLatin = TransliterationService.IsPotentiallyLatin(filterTerm);
                string filterCyrillic = looksLatin ? TransliterationService.ToCyrillic(filterTerm) : filterTerm;
                string filterLatin = looksLatin ? filterTerm : TransliterationService.ToLatin(filterTerm);
                bool shouldCheckLatin = looksLatin;

                Ayas = AllAyas.Where(a =>
                {
                    bool ContainsMatch(string source)
                    {
                        if (string.IsNullOrEmpty(source))
                            return false;

                        if (!string.IsNullOrEmpty(filterCyrillic) && source.IndexOf(filterCyrillic, comparison) >= 0)
                            return true;

                        if (shouldCheckLatin)
                        {
                            var latinSource = TransliterationService.ToLatin(source);
                            if (!string.IsNullOrEmpty(latinSource) && latinSource.IndexOf(filterLatin, comparison) >= 0)
                                return true;
                        }

                        return false;
                    }

                    if (ContainsMatch(a.Text))
                        return true;

                    if (!string.IsNullOrEmpty(a.Comment) && ContainsMatch(a.Comment))
                        return true;

                    return false;
                }).ToList();
            }

            await InvokeAsync(StateHasChanged);
        });
    }

    private async Task ClearAyaSearch()
    {
        AyaFilter = string.Empty;
        Ayas = AllAyas;
        await InvokeAsync(StateHasChanged);
    }

    private string StripHtml(string input)
    {
        if (string.IsNullOrEmpty(input)) return string.Empty;
        // First, remove HTML tags
        var noHtmlTags = Regex.Replace(input, "<.*?>", string.Empty);
        // Then, decode HTML entities
        return System.Net.WebUtility.HtmlDecode(noHtmlTags);
    }

    private async Task ShareAya(Aya aya)
    {
        string suraNameDisplay = TransliterationService.GetDisplayText(SuraName);
        string ayaTextDisplay = TransliterationService.GetDisplayText(aya.Text);
        string plainCommentDisplay = TransliterationService.GetDisplayText(StripHtml(aya.Comment));
        string titlePart1 = TransliterationService.GetDisplayText("Оят:");
        string titlePart2 = TransliterationService.GetDisplayText("сураси,");
        string titlePart3 = TransliterationService.GetDisplayText(". ояти");
        string title = $"{titlePart1} {suraNameDisplay} {titlePart2} {aya.AyaId}{titlePart3}";//$"Оят: {SuraName} сураси, {aya.AyaId}. ояти";
        //string plainComment=StripHtml(aya.Comment);
        await Share.Default.RequestAsync(new ShareTextRequest
            {
                Title = title,
                Text = $"{title}\n{aya.Arabic}\n{ayaTextDisplay}\n{plainCommentDisplay}",
                Uri = "https://www.musulmonlar.com"
            });
    }


    private string ProcessComment(int ayaId, string cyrillicCommentFromDb)
    {
        if (string.IsNullOrEmpty(cyrillicCommentFromDb)) return string.Empty;

        bool renderLatin = _isLatinScriptPreferred;
        string cacheKey = $"{ayaId}_{renderLatin}";

        if (_processedCommentsCache.TryGetValue(cacheKey, out var cachedResult))
        {
            return cachedResult;
        }

        var resultHtml = new System.Text.StringBuilder();
        int lastIndex = 0;

        try
        {
            foreach (Match match in CommentLinkRegex.Matches(cyrillicCommentFromDb))
            {
                // Append the text segment before this match, transliterated
                string textBeforeMatch = cyrillicCommentFromDb.Substring(lastIndex, match.Index - lastIndex);
                resultHtml.Append(renderLatin ? TransliterationService.ToLatin(textBeforeMatch) : textBeforeMatch);

                // Process the matched part (the link pattern)
                // match.Groups[1].Value is the Cyrillic text inside parentheses
                var commentPartsInParentheses = match.Groups[1].Value.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries);
                var processedLinkParts = new List<string>();

                foreach (var partContentCyrillic in commentPartsInParentheses) // partContent is Cyrillic, e.g., "Мўминун 23:70"
                {
                    var trimmedCyrillicPart = partContentCyrillic.Trim(); // Still Cyrillic

                    // This is the text that will be displayed for the link. Convert it to the target script.
                    string linkDisplayTextInTargetScript = renderLatin ? TransliterationService.ToLatin(trimmedCyrillicPart) : trimmedCyrillicPart;

                    // Parse SuraId and AyaId from the original Cyrillic trimmedPart
                    var subParts = trimmedCyrillicPart.Split(new[] { ':' }, StringSplitOptions.RemoveEmptyEntries);
                    if (subParts.Length == 2 && subParts[0].Trim().Contains(' '))
                    {
                        var suraDetailsParts = subParts[0].Trim().Split(' ');
                        var suraIdStr = suraDetailsParts.Last();
                        var ayaNumStr = subParts[1].Trim().Split('-')[0];

                        if (int.TryParse(suraIdStr, out int parsedSuraId) && int.TryParse(ayaNumStr, out int parsedAyaId))
                        {
                            // Construct the link with ASCII HTML tags and the already-scripted linkDisplayText
                            processedLinkParts.Add($"<a href=\"/AyaList?SuraId={parsedSuraId}#{parsedAyaId}\">{linkDisplayTextInTargetScript}</a>");
                        }
                        else
                        {
                            processedLinkParts.Add(linkDisplayTextInTargetScript); // Fallback if parsing fails
                        }
                    }
                    else
                    {
                        processedLinkParts.Add(linkDisplayTextInTargetScript); // Fallback if not in "SuraName SuraId:AyaId" format
                    }
                }
                resultHtml.Append($"({string.Join(", ", processedLinkParts)})");

                lastIndex = match.Index + match.Length;
            }

            // Append the rest of the string (if any) after the last match, transliterated
            string remainingText = cyrillicCommentFromDb.Substring(lastIndex);
            resultHtml.Append(renderLatin ? TransliterationService.ToLatin(remainingText) : remainingText);

            var result = resultHtml.ToString();
            _processedCommentsCache[cacheKey] = result;
            return result;
        }
        catch (Exception exception)
        {
            Console.Error.WriteLine($"Error processing comment in AyaList: {exception.Message}");
            // Fallback: return original comment, transliterated to the target script if possible (assuming it's plain text)
            return renderLatin ? TransliterationService.ToLatin(cyrillicCommentFromDb) : cyrillicCommentFromDb;
        }
    }
}
<div class="text-white mb-3">
    <div class="position-relative">
        <input class="form-control me-2 rounded-pill primary-color p-3 pe-5" id="floatingSearch" type="search" placeholder="@TransliterationService.GetDisplayText("Оят Излаш")" @bind="AyaFilter" @bind:event="oninput" @bind:after="FilterAya" aria-label="Оят Излаш">
        @if (!string.IsNullOrEmpty(AyaFilter))
        {
            <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y me-2" @onclick="ClearAyaSearch" aria-label="@TransliterationService.GetDisplayText("Тозалаш")">
                <img src="close.svg" class="svg-icon svg-icon-md" alt="Clear" />
            </button>
        }
    </div>
</div>

<div class="card-header text-center vstack shadow-lg rounded-pill py-2" id="surahead">
    <h3 class="card-title fs-3 text-primary">@SuraId. @TransliterationService.GetDisplayText(SuraName) @TransliterationService.GetDisplayText(" сураси")</h3>
    @if (SuraId is not (1 or 9))
    {
        <h4 class="text-center arabic mx-auto fs-2">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</h4>
    }
</div>
@if (isLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger text-center">@errorMessage</div>
}
else
{
    @if (Ayas != null)
    {
        foreach (var aya in Ayas)
        {
            <div class="row my-3" id="@aya.AyaId">
                    <div class="col">
                        <div class="card bg-light bg-gradient rounded-pill">
                            <div class="card-body">
                                <div class="vstack">
                                    <h5 class="card-title header-bg-color hstack rounded-3 gap-3 text-white ">
                                        <span class="bg-gradient border-3 rounded-2 shadow-lg me-auto p-2 ms-1" aria-label="@TransliterationService.GetDisplayText("Оят рақами")">@aya.AyaId</span>
                                        <button type="button" class="btn btn-link p-0 border-0 bg-transparent" style="min-width: 44px; min-height: 44px;" @onclick="async () => await ShareAya(aya)" aria-label="@TransliterationService.GetDisplayText("Оятни баҳам кўриш")" title="@TransliterationService.GetDisplayText("Оятни баҳам кўриш")">
                                            <img src="share.svg" class="svg-icon svg-icon-lg svg-icon-white" alt="" />
                                        </button>
                                        <button type="button" class="btn btn-link p-0 border-0 bg-transparent" style="min-width: 44px; min-height: 44px;" @onclick="() => ShowCollectionsDialog(aya)" aria-label="@(aya.IsFavorite ? TransliterationService.GetDisplayText("Тўпламларда") : TransliterationService.GetDisplayText("Тўпламларга қўшиш"))" title="@(aya.IsFavorite ? TransliterationService.GetDisplayText("Тўпламларда") : TransliterationService.GetDisplayText("Тўпламларга қўшиш"))">
                                            <img src="@(aya.IsFavorite ? "favorite_fill.svg" : "favorite.svg")" class="svg-icon svg-icon-lg svg-icon-white" alt="" />
                                        </button>
                                        <button type="button" class="btn btn-link p-0 border-0 bg-transparent" style="min-width: 44px; min-height: 44px;" @onclick="() => NoteAsync(aya)" aria-label="@(aya.HasNote ? TransliterationService.GetDisplayText("Қайдни таҳрирлаш ёки ўчириш") : TransliterationService.GetDisplayText("Қайд қўшиш"))" title="@(aya.HasNote ? TransliterationService.GetDisplayText("Қайдни таҳрирлаш ёки ўчириш") : TransliterationService.GetDisplayText("Қайд қўшиш"))">
                                            <img src="@(aya.HasNote ? "edit_note.svg" : "note_add.svg")" class="svg-icon svg-icon-lg svg-icon-white" alt="" />
                                        </button>
                                        <button type="button" class="btn btn-link p-0 border-0 bg-transparent me-3" style="min-width: 44px; min-height: 44px;" @onclick="() => Bookmark(aya)" aria-label="@TransliterationService.GetDisplayText("Сўнги ўқилган оят деб белгилаш")" title="@TransliterationService.GetDisplayText("Сўнги ўқилган оят деб белгилаш")">
                                            <img src="@((SuraId + ":" + aya.AyaId == bookmarkAya) ? "bookmark_fill.svg" : "bookmark_add.svg")" class="svg-icon svg-icon-lg svg-icon-white" alt="" />
                                        </button>
                                    </h5>
                                    @if (showArabicText)
                                    {
                                        <p class="arabic mb-0 me-2 " style=@arabicStyle>@aya.Arabic</p>
                                    }
                                    @if (string.IsNullOrEmpty(AyaFilter))
                                    {
                                        @if (showTranslation)
                                        {
                                            <p class="my-2" style=@textStyle>@((MarkupString)TransliterationService.GetDisplayText(aya.Text))</p>
                                        }
                                        @if (showFootnotes && aya.Comment != null)
                                        {
                                            <hr />
                                            <p style=@commentStyle>@((MarkupString)ProcessComment(aya.AyaId, aya.Comment))</p>
                                        }
                                    }
                                    else
                                    {
                                        @if (showTranslation)
                                        {
                                            <p class="my-2" style=@textStyle>
                                                @((MarkupString)TransliterationService.GetDisplayText(aya.Text).Replace(AyaFilter, "<span class='search-term'>" + AyaFilter + "</span>", StringComparison.OrdinalIgnoreCase))
                                            </p>
                                        }
                                        @if (showFootnotes && aya.Comment != null)
                                        {
                                            <hr />
                                            <p style=@commentStyle>
                                                @((MarkupString)ProcessComment(aya.AyaId, aya.Comment).Replace(AyaFilter, "<span class='search-term'>" + AyaFilter + "</span>", StringComparison.OrdinalIgnoreCase))
                                            </p>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        }
    }
    <button id="BackToTop" type="button" class="Shown" @onclick="BackToTop" aria-label="@TransliterationService.GetDisplayText("Юқорига қайтиш")"></button>
}

@if (showCollectionsDialog && selectedAyaForCollection != null)
{
    <div class="modal show d-block modal-fade-in" tabindex="-1" style="background-color: rgba(0,0,0,0.6);" @onclick="CloseCollectionsDialog">
        <div class="modal-dialog modal-dialog-centered modal-slide-up" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@TransliterationService.GetDisplayText("Тўпламга қўшиш")</h5>
                    <button type="button" class="btn-close" @onclick="CloseCollectionsDialog" aria-label="@TransliterationService.GetDisplayText("Ёпиш")"></button>
                </div>
                <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                    @if (!showCreateNewInDialog)
                    {
                        @if (availableCollections == null || !availableCollections.Any())
                        {
                            <div class="text-center py-3">
                                <img src="collections_bookmark.svg" class="svg-icon svg-icon-xxl mb-3 opacity-50 svg-icon-light" alt="" />
                                <p class="text-muted">@TransliterationService.GetDisplayText("Сизда ҳали тўпламлар йўқ")</p>
                            </div>
                        }
                        else
                        {
                            <div class="list-group">
                                @foreach (var collection in availableCollections)
                                {
                                    var isInCollection = ayaCollections.Contains(collection.Id);
                                    <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(isInCollection ? "active" : "")" 
                                            @onclick="() => ToggleCollection(collection.Id)"
                                            style="min-height: 48px;">
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(collection.ColorCode))
                                            {
                                                <span class="badge me-2" style="background-color: @collection.ColorCode; width: 16px; height: 16px;"></span>
                                            }
                                            <span>@TransliterationService.GetDisplayText(collection.Name)</span>
                                        </div>
                                        @if (isInCollection)
                                        {
                                            <span class="badge bg-success">✓</span>
                                        }
                                    </button>
                                }
                            </div>
                        }
                        
                        <button type="button" class="btn btn-outline-primary rounded-pill w-100 mt-3" @onclick="ShowCreateNewCollection" style="min-height: 48px;">
                            <img src="note_add.svg" class="svg-icon svg-icon-md me-2 svg-icon-primary" alt="" />
                            @TransliterationService.GetDisplayText("Янги тўплам яратиш")
                        </button>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">@TransliterationService.GetDisplayText("Янги тўплам номи")</label>
                            <input type="text" class="form-control form-control-lg" @bind="newCollectionName" 
                                   placeholder="@TransliterationService.GetDisplayText("Масалан: Севимли дуолар")" 
                                   @onkeyup="@(async (e) => { if (e.Key == "Enter") await CreateAndAddToNewCollection(); })" />
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary rounded-pill flex-fill" @onclick="CancelCreateNewCollection" style="min-height: 48px;">
                                @TransliterationService.GetDisplayText("Бекор қилиш")
                            </button>
                            <button type="button" class="btn btn-primary rounded-pill flex-fill" @onclick="CreateAndAddToNewCollection" 
                                    disabled="@(string.IsNullOrWhiteSpace(newCollectionName))" style="min-height: 48px;">
                                @TransliterationService.GetDisplayText("Яратиш ва қўшиш")
                            </button>
                        </div>
                    }
                </div>
                @if (!showCreateNewInDialog)
                {
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary rounded-pill" @onclick="CloseCollectionsDialog" style="min-height: 44px;">
                            @TransliterationService.GetDisplayText("Ёпиш")
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
}